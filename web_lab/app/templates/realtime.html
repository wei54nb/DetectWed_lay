<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
  <title>NKUST - 即時動作分析</title>
  <style>
      /* 基礎設置 */
      * {
          box-sizing: border-box;
          margin: 0;
          padding: 0;
          font-family: Arial, sans-serif;
          text-decoration: none;
          font-size: 16px;
      }

      body {
          margin: 0;
          background-color: #f4f4f4;
          overflow-x: hidden;
          min-height: 100vh;
      }

      .header {
          display: flex;
          flex-wrap: wrap;
          justify-content: space-between;
          align-items: center;
          background-color: #fff;
          padding: clamp(10px, 2vw, 20px);
          border-bottom: 2px solid #00BCD4;
          min-height: 80px;
      }

      .logo-container {
          display: flex;
          align-items: center;
          gap: clamp(15px, 2vw, 30px);
          flex-wrap: wrap;
      }

      .logo-container img {
          height: clamp(40px, 8vw, 80px);
          width: auto;
      }

      .logo-container span {
          font-size: clamp(1.2rem, 2vw, 2rem);
          font-weight: bold;
          color: #000;
      }

      .nav-buttons {
          display: flex;
          gap: clamp(10px, 2vw, 90px);
          flex-wrap: wrap;
      }

      .button {
          display: inline-block;
          padding: 0.75rem 1.5rem;
          border-radius: 0.5rem;
          color: #fff;
          text-transform: uppercase;
          font-size: clamp(0.8rem, 1.5vw, 1rem);
          letter-spacing: 0.15rem;
          transition: all 0.3s;
          position: relative;
          overflow: hidden;
          z-index: 1;
          text-align: center;
          background-color: #00BCD4;
          text-decoration: none;
          cursor: pointer;
          border: none;
          min-width: clamp(60px, 10vw, 120px);
      }

      .button:after {
          content: '';
          position: absolute;
          bottom: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: #00BCD4;
          border-radius: 0.5rem;
          z-index: -2;
      }

      .button:before {
          content: '';
          position: absolute;
          bottom: 0;
          left: 0;
          width: 0%;
          height: 100%;
          background-color: #0088cc;
          transition: all 0.3s;
          border-radius: 0.5rem;
          z-index: -1;
      }

      .button:hover {
          color: #fff;
      }

      .button:hover:before {
          width: 100%;
      }

      .content {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
          gap: clamp(10px, 2vw, 20px);
          padding: clamp(10px, 2vw, 20px);
          padding-bottom: 140px;
          max-width: 1600px;
          margin: 0 auto;
          position: relative;
      }

      .control-panel {
          display: flex;
          gap: 10px;
          flex-wrap: wrap;
          margin: 20px 0;
          position: relative;
          z-index: 100;
      }

      .control-panel .button,
      .control-panel select {
          min-width: 120px;
          margin: 5px;
      }

      .video-container {
          width: 100%;
          max-width: 560px;
          margin: 0 auto;
      }

      .video-container img,
      .video-container video {
          width: 100%;
          height: auto;
          max-height: 560px;
          object-fit: contain;
          border-radius: 8px;
      }

      .data-inputs {
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 30px;
          margin: 20px 0;
          max-width: 800px;
      }

      .data-inputs .input-group {
          display: flex;
          flex-direction: column;
          padding: 12px;
          background: rgba(0, 188, 212, 0.1);
          border-radius: 8px;
          height: auto;
          min-height: 65px;
      }

      .data-inputs .input-group label {
          font-size: 14px;
          color: #333;
          margin-bottom: 8px;
      }

      .data-inputs .input-group input {
          padding: 8px 12px;
          font-size: 14px;
          border: 1px solid #00BCD4;
          border-radius: 4px;
          width: 100%;
          height: 36px;
      }

      .angle-display {
          background-color: #333;
          padding: 15px;
          border-radius: 8px;
          color: #fff;
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
          gap: 10px;
          margin: 20px 0;
      }

      .angle-card {
          background-color: rgba(0, 188, 212, 0.1);
          border-radius: 5px;
          padding: 10px;
          text-align: center;
      }

      .angle-label {
          font-size: 14px;
          color: #00BCD4;
          margin-bottom: 5px;
      }

      .angle-value {
          font-size: 18px;
          font-weight: bold;
      }

      .exercise-counter {
          background-color: #00BCD4;
          color: white;
          padding: clamp(15px, 3vw, 20px);
          border-radius: 10px;
          margin: 20px 0;
          text-align: center;
      }

      .exercise-selector {
          padding: 0.75rem 1.5rem;
          border-radius: 0.5rem;
          border: 1px solid #00BCD4;
          font-size: clamp(0.8rem, 1.5vw, 1rem);
          background-color: white;
          cursor: pointer;
      }

      .counter-value {
          font-size: clamp(24px, 5vw, 48px);
          font-weight: bold;
          margin: 10px 0;
      }

      .counter-label {
          font-size: clamp(18px, 3vw, 24px);
      }

      .bottom-stats-container {
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          background: linear-gradient(to right, #00BCD4, #0097a7);
          padding: clamp(10px, 2vw, 15px);
          display: flex;
          flex-wrap: wrap;
          justify-content: center;
          gap: clamp(15px, 2vw, 30px);
          box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
          z-index: 1000;
          height: auto;
          max-height: 120px;
      }

      .stats-card {
          background: rgba(255, 255, 255, 0.1);
          padding: 15px 30px;
          border-radius: 10px;
          text-align: center;
          color: white;
          min-width: 200px;
          flex: 1;
          max-width: 300px;
      }

      .stats-label {
          font-size: clamp(14px, 2vw, 16px);
          margin-bottom: 5px;
          color: rgba(255, 255, 255, 0.9);
      }

      .stats-value {
          font-size: clamp(20px, 3vw, 28px);
          font-weight: bold;
      }

      .export-button {
          background: #4CAF50;
          color: white;
          padding: 10px 20px;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          transition: background 0.3s;
          font-size: clamp(14px, 2vw, 16px);
      }

      .export-button:hover {
          background: #45a049;
      }

      /* 優化後的教練提示視窗樣式 */
      .coach-tip-container {
          position: fixed;
          left: 20px;
          bottom: 120px;
          width: clamp(250px, 50vw, 450px); /* Increased width */
          height: clamp(200px, 40vh, 300px); /* Added height */
          background: linear-gradient(135deg, #ffffff, #e6f2f4);
          border-radius: 15px;
          box-shadow: 0 10px 20px rgba(0, 0, 0, 0.12);
          border: 2px solid #00BCD4;
          overflow: hidden;
          display: flex;
          flex-direction: column;
      }

      .coach-tip-container:hover {
          transform: scale(1.02);
      }

      .coach-title {
          font-size: 22px;
          font-weight: 700;
          color: white;
          letter-spacing: 1px;
      }

      .coach-tip-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          background: #00BCD4;
          padding: 15px 20px;
      }

      .coach-tip-content {
          padding: 15px;
          display: flex;
          align-items: center;
          justify-content: center;
          height: calc(100% - 40px);
      }

      .coach-tip-text {
          font-size: 16px;
          line-height: 1.6;
          color: #333;
          font-weight: 600; /* Increased font weight for bolder text */
          background: rgba(255, 255, 255, 0.9);
          padding: 15px;
          border-radius: 10px;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          max-height: 150px;
          overflow-y: auto;
          text-align: left;
          white-space: pre-wrap;
          word-wrap: break-word;
          transition: background-color 0.3s ease;
      }

      .coach-tip-text:hover {
          background: rgba(0, 188, 212, 0.08);
      }


      .quality-display {
          display: flex;
          align-items: baseline;
          gap: 8px;
          background: rgba(255, 255, 255, 0.2);
          padding: 8px 15px;
          border-radius: 20px;
      }

      .quality-title {
          font-size: 16px;
          color: rgba(255, 255, 255, 0.9);
          font-weight: 600;
      }

      .quality-value {
          font-size: 28px;
          font-weight: 800;
          color: #FFEB3B;
      }

      .quality-max {
          font-size: 18px;
          color: rgba(255, 255, 255, 0.7);
      }

      .coach-tip-content {
          flex-grow: 1;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 25px;
          background: white;
      }


      /* 媒體查詢 */
      @media (max-width: 768px) {
          .coach-tip-container {
              width: 90%;
              left: 5%;
              bottom: 100px;
          }

          .content {
              padding-bottom: 160px;
          }

          .control-panel {
              flex-direction: column;
              align-items: stretch;
          }

          .control-panel .button,
          .control-panel select {
              width: 100%;
              margin: 5px 0;
          }

          .header {
              flex-direction: column;
              gap: 15px;
              padding: 15px;
          }

          .nav-buttons {
              width: 100%;
              justify-content: center;
          }

          .bottom-stats-container {
              flex-direction: column;
              align-items: center;
          }

          .stats-card {
              width: 100%;
          }

          .coach-tip-text {
              font-size: 18px;
              font-weight: 600; /* Maintained bolder font weight */
              padding: 12px;
              max-height: 150px;
          }


      }

      @media (max-width: 480px) {
          .content {
              padding-bottom: 180px;
          }

          .bottom-stats-container {
              padding: 8px;
          }

          .logo-container {
              flex-direction: column;
              text-align: center;
          }

          .button {
              padding: 0.5rem 1rem;
              font-size: 0.9rem;
              width: 100%;
          }

          .data-inputs {
              grid-template-columns: 1fr;
          }

          .angle-display {
              grid-template-columns: 1fr;
          }

          .stats-card {
              padding: 8px;
              min-width: 150px;
          }


        /* 新增/修改CSS样式 */
        .coach-tip-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #00BCD4;
            padding: 12px 20px;
            border-bottom: 2px solid #0088cc;
        }

        .coach-title {
            font-size: 20px;
        }

          .quality-display {
              display: flex;
              align-items: baseline;
              gap: 8px;
              background: rgba(255, 255, 255, 0.2);
              padding: 8px 15px;
              border-radius: 20px;
          }

          .quality-title {
              font-size: 16px;
              color: rgba(255, 255, 255, 0.9);
              font-weight: 600;
          }


          /* 字体大小优化 */
        .score-title {
          font-size: 1.4rem !important;
          color: #fff !important;
          margin-bottom: 8px;
          letter-spacing: 1px;
        }

        .score-value {
          font-size: 2.8rem !important;
          font-weight: 800 !important;
          color: #FFEB3B !important;
          text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
          line-height: 1;
        }

        .score-max {
          font-size: 1.2rem !important;
          color: rgba(255, 255, 255, 0.8) !important;
          margin-left: 5px;
        }

        /* 教練視窗位置微调 */
          .coach-tip-container {
              left: 5%;
              bottom: 80px;
              width: 90%;
              height: auto;
          }

          .quality-value {
              font-size: 28px;
              font-weight: 800;
              color: #FFEB3B;
          }

          .quality-max {
              font-size: 18px;
              color: rgba(255, 255, 255, 0.7);
          }

        /* 调整整体容器高度 */
        .coach-tip-content {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 25px;
            background: white;
        }


        .quality-score {
            font-size: clamp(24px, 5vw, 48px);
            font-weight: bold;
        }

          .coach-tip-text {
              font-size: 16px;
          }

      }
    add text after this line
    .monster-display {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #ffe0b2;
        border: 2px solid #f57c00;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        padding: 15px;
        z-index: 2000;
        font-family: Arial, sans-serif;
        color: #4e342e;
        font-size: 14px;
    }
    </style>
</head>

<body>
<div class="header">
    <div class="logo-container">
        <img src="{{ url_for('static', filename='img/nkust.png') }}" alt="NKUST Logo">
        <span>國立高雄科技大學</span>
    </div>
    <div class="nav-buttons">
        <a href="{{ url_for('main.index') }}" class="button">回首頁</a>
        <button class="button">動作知識</button>
        <button class="button">器材介紹</button>
    </div>
</div>

<div class="content">
    <div class="bottom-stats-container">
        <div class="stats-card">
            <div class="stats-label">完成次數</div>
            <div class="stats-value" id="exercise-count-stats">0</div>
        </div>
        <button id="export-excel" class="export-button">導出戰績</button>
    </div>

    <div class="data-inputs">
        <div class="input-group">
            <label for="student-id">學生ID</label>
            <input type="text" id="student-id" placeholder="請輸入學號">
        </div>
        <div class="input-group">
            <label for="weight">重量(Kg)</label>
            <input type="number" id="weight" placeholder="請輸入重量">
        </div>
        <div class="input-group">
            <label for="sets">組數</label>
            <input type="number" id="sets" placeholder="請輸入組數">
        </div>
        <div class="input-group">
            <label for="reps">每組次數</label>
            <input type="number" id="reps" placeholder="請輸入每組次數">
        </div>
    </div>

    <div class="video-container">
        <img id="video-feed" src="{{ url_for('exercise.video_feed') }}" alt="Real-time Video Feed">
    </div>

    <div class="data-container">
        <h2>即時數據</h2>
        <div class="exercise-counter">
            <div class="counter-label">運動次數</div>
            <div class="counter-value" id="exercise-count">0</div>
            
        </div>
        <div class="exercise-counter">
            <div class="counter-label">剩餘組數</div>
            <div class="counter-value" id="remaining-sets">0</div>
        </div>

        <div class="control-panel">
            <select id="exercise-type" class="exercise-selector">
                <option value="squat">深蹲訓練</option>
                <option value="bicep-curl">二頭訓練</option>
                <option value="shoulder-press">肩推訓練</option>
                <option value="push-up">伏地挺身</option>
                <option value="pull-up">引體向上</option>
                <option value="dumbbell-row">啞鈴划船</option>
            </select>
            <button id="start-detection" class="button">開始偵測</button>
            <button id="stop-detection" class="button">停止偵測</button>
        </div>
        <div class="angle-display">
            <!-- 角度數據將在這裡動態更新 -->
        </div>

        <!-- 教練提示視窗放在左下角 -->
        <div class="coach-tip-container">
            <div class="coach-tip-header">
                <div class="coach-title">即時健身教練</div>
                <div class="quality-display">
                    <div class="quality-title">品質評分</div>
                    <div class="quality-value">0</div>
                    <div class="quality-max">/5</div>
                </div>
            </div>
            <div class="coach-tip-content">
                <div class="coach-tip-text">
                    請選擇運動類型並開始偵測以獲得即時建議。
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // 使用正确的命名空间连接
        const startButton = document.getElementById('start-detection');
        const stopButton = document.getElementById('stop-detection');
        const exerciseSelect = document.getElementById('exercise-type');
        const videoFeed = document.getElementById('video-feed');
        const exerciseCount = document.getElementById('exercise-count');
        const exerciseCountStats = document.getElementById('exercise-count-stats');
        const remainingSetsDisplay = document.getElementById('remaining-sets');
        const coachTipText = document.querySelector('.coach-tip-text');
        const qualityScore = document.querySelector('.quality-value');
        const qualityTitle = document.querySelector('.quality-title');
        const qualityDisplay = document.querySelector('.quality-display');
        const setDetectionLineButton = document.getElementById('set-detection-line');
        const resetCountButton = document.getElementById('reset-count');
        const exportExcelButton = document.getElementById('export-excel');
        const socket = io.connect('/exercise');
        
        // 创建怪物容器
        const monsterContainer = document.createElement('div');
        monsterContainer.id = 'monster-container';
        monsterContainer.classList.add('monster-display');
        document.body.appendChild(monsterContainer);
        
        // 怪物事件监听
        socket.on('monster_event', (data) => {
            try {
                updateMonsterInfo(data);
                if (data.health && data.health < 20) {
                    alert('警告：怪物健康值過低！');
                }
            } catch (error) {
                console.error('處理怪物數據錯誤:', error);
                alert('無法更新怪物資訊，請稍後再試！');
            }
        });

        // 確保所有關鍵元素存在的檢查
        const requiredElements = [
            {element: startButton, name: '開始偵測按鈕'},
            {element: stopButton, name: '停止偵測按鈕'},
            {element: exerciseSelect, name: '運動類型選擇'},
            {element: videoFeed, name: '視頻源'},
            {element: exerciseCount, name: '運動次數顯示'},
            {element: coachTipText, name: '教練提示文本'}
        ];

        const missingElements = requiredElements.filter(item => !item.element);
        if (missingElements.length > 0) {
            console.error('以下元素未找到:', missingElements.map(item => item.name).join(', '));
            alert('頁面初始化失敗，請重新載入頁面');
            return;
        }

        // 設定初始按鈕狀態
        startButton.disabled = false;
        stopButton.disabled = true;

        // 初始化變數
        let exerciseReps = 0;
        let remainingSets = 0;
        let detectionLineY = null;
        let currentQualityScore = 0;
        let scoreResetTimer = null;
        const SCORE_RESET_TIMEOUT = 10000; // 10秒後無更新則歸零

        // 全域變數，用於二頭彎舉記數狀態
        let bicep_state = "down";
        let last_curl_time = 0;

        // Socket.IO 事件處理
        socket.on('connect', () => {
            console.log('已連接到 Socket.IO 伺服器');
            if (document.getElementById('connection-status')) {
                document.getElementById('connection-status').textContent = '已连接';
                document.getElementById('connection-status').style.color = 'green';
            }
        });

        socket.on('disconnect', () => {
            console.log('与服务器断开连接');
            if (document.getElementById('connection-status')) {
                document.getElementById('connection-status').textContent = '已断开';
                document.getElementById('connection-status').style.color = 'red';
            }
        });

        socket.on('video_frame', (data) => {
            if (videoFeed) {
                videoFeed.src = 'data:image/jpeg;base64,' + data.frame;
            }
        });

        socket.on('exercise_count', (data) => {
            if (exerciseCount) {
                exerciseCount.textContent = data.count;
            }
            
            // 如果有质量评分，更新质量评分
            if (data.quality !== undefined && document.getElementById('quality-score')) {
                document.getElementById('quality-score').textContent = data.quality;
            }
        });

        // 監聽各運動評分事件
        socket.on('squat_quality', (data) => {
            console.log("收到深蹲品質評分數據:", data);
            if (!data || typeof data.score === 'undefined') {
                console.error("深蹲品質評分數據格式不正確:", data);
                return;
            }
            updateQualityScore('squat_quality', data);
        });

        socket.on('shoulder_press_score', (data) => {
            console.log("Received shoulder_press_score:", data);
            updateQualityScore('shoulder_press_score', data);
        });

        socket.on('bicep_curl_score', (data) => {
            console.log("Received bicep_curl_score:", data);
            updateQualityScore('bicep_curl_score', data);
        });

        socket.on('exercise_count_update', (data) => {
            console.log("Received exercise_count_update:", data);
            exerciseCount.textContent = data.count;
            exerciseCountStats.textContent = data.count;
            exerciseReps++;
            const repsGoal = parseInt(document.getElementById('reps').value) || 0;
            if (repsGoal > 0 && exerciseReps >= repsGoal && remainingSets > 0) {
                exerciseReps = 0;
                remainingSets--;
                remainingSetsDisplay.textContent = remainingSets;
                if (remainingSets <= 0) {
                    alert("已完成所有組數！");
                    stopButton.click();
                }
            }
        });

        socket.on('angle_data', (data) => {
            console.log("收到角度數據:", data);
                if (!data || Object.keys(data).length === 0) {
                    console.error("角度數據為空或格式不正確");
                    return;
                }
                // 更新角度顯示
                const angleDisplay = document.querySelector('.angle-display');
                if (angleDisplay) {
                    angleDisplay.innerHTML = "";
                    for (let key in data) {
                        const angleElement = document.createElement("div");
                        angleElement.classList.add("angle-card");
                        angleElement.innerHTML = `<div class="angle-label">${key}</div>
                                            <div class="angle-value">${data[key].toFixed(1)}°</div>`;
                        angleDisplay.appendChild(angleElement);
                    }
                    // 確保調用教練提示更新函數
                    updateCoachTips(data);
                }
            });

        socket.on('detection_line_set', (data) => {
            if (data.error) {
                alert(`設置偵測線失敗：${data.error}`);
            } else {
                detectionLineY = data.detection_line_y;
                alert(`偵測線已設定完成！位置：${detectionLineY}px`);
            }
        });

        // 開始偵測按鈕事件
        if (startButton) {
            function handleFetchError(error, context) {
                console.error(`${context} 錯誤:`, error);
                alert(`${context}失敗：${error.message || '未知錯誤'}`);
            }

            startButton.addEventListener('click', () => {
                const exerciseType = exerciseSelect.value;
                const weight = document.getElementById('weight').value;
                const reps = document.getElementById('reps').value;
                const sets = document.getElementById('sets').value;
                const studentId = document.getElementById('student-id').value;

                console.log("開始偵測 - 發送請求參數:", {exerciseType, weight, reps, sets, studentId});
                fetch(`/exercise/start_detection?exercise_type=${exerciseType}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({weight, reps, sets, student_id: studentId})
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('後端回應失敗');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        startButton.disabled = true;
                        stopButton.disabled = false;
                        exerciseCount.textContent = '0';
                        exerciseReps = 0;
                        remainingSets = parseInt(sets) || 0;
                        remainingSetsDisplay.textContent = remainingSets;
                        videoFeed.src = `/exercise/video_feed?t=${new Date().getTime()}`;
                        coachTipText.textContent = '正在偵測，請保持動作標準...';

                        // 重置品質評分
                        if (qualityScore) {
                            qualityScore.textContent = '0';
                            qualityScore.style.color = '';
                        }
                        currentQualityScore = 0;

                        // 根據運動類型顯示/隱藏品質評分
                        if (qualityDisplay) {
                            qualityDisplay.style.display = (exerciseType === 'squat' || exerciseType === 'shoulder-press' || exerciseType === 'bicep-curl') ? 'block' : 'none';
                        }

                        resetScoreTimer();
                    } else {
                        throw new Error('後端回應失敗');
                    }
                })
                .catch(error => {
                    console.error('開始偵測錯誤:', error);
                    alert(`啟動偵測失敗: ${error.message}`);
                });
            });
        }

        // 停止偵測按鈕事件
        if (stopButton) {
            stopButton.addEventListener('click', () => {
                console.log("停止偵測 - 發送請求");
                fetch('/exercise/stop_detection', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                })
                .then(response => {
                    if (!response.ok) throw new Error('停止偵測失敗');
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        startButton.disabled = false;
                        stopButton.disabled = true;
                        videoFeed.src = '';
                        coachTipText.textContent = '偵測已停止，請重新開始以獲得建議。';
                        exerciseReps = 0;
                        remainingSets = 0;
                        remainingSetsDisplay.textContent = '0';

                        if (scoreResetTimer) {
                            clearTimeout(scoreResetTimer);
                            scoreResetTimer = null;
                        }

                        if (qualityScore) {
                            qualityScore.textContent = '0';
                            qualityScore.style.color = '';
                        }
                        currentQualityScore = 0;
                    } else {
                        throw new Error('後端回應失敗');
                    }
                })
                .catch(error => {
                    console.error('停止偵測錯誤:', error);
                    alert(`停止偵測失敗: ${error.message}`);
                });
            });
        }

        // 設置偵測線按鈕事件
        if (setDetectionLineButton) {
            setDetectionLineButton.addEventListener('click', () => {
                socket.emit('set_detection_line');
                alert('正在啟動攝像機並設置偵測線，請在鏡頭前保持站立姿勢，系統將根據您的髖關節位置設置偵測線');
                videoFeed.src = `/video_feed?t=${new Date().getTime()}`;
            });
        }

        // 重置计数按钮事件
        if (resetCountButton) {
            resetCountButton.addEventListener('click', () => {
                socket.emit('reset_count');
                console.log('发送重置计数请求');
            });
        }
        
        // 导出Excel按钮事件
        if (exportExcelButton) {
            exportExcelButton.addEventListener('click', () => {
                const studentId = document.getElementById('student-id').value;
                const exerciseType = exerciseSelect.value;
                const weight = document.getElementById('weight').value;
                const count = exerciseCount.textContent;
                
                if (!studentId) {
                    alert('請先輸入學號');
                    return;
                }
                
                console.log('导出Excel数据:', {studentId, exerciseType, weight, count});
                
                fetch('/exercise/export_data', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        student_id: studentId,
                        exercise_type: exerciseType,
                        weight: weight,
                        count: count
                    })
                })
                .then(response => {
                    if (!response.ok) throw new Error('導出數據失敗');
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `exercise_data_${studentId}_${new Date().toISOString().slice(0,10)}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    alert('數據導出成功！');
                })
                .catch(error => {
                    console.error('導出數據錯誤:', error);
                    alert(`導出數據失敗: ${error.message}`);
                });
            });
        }

        // 運動類型變更時更新品質評分標題和重置分數
        if (exerciseSelect) {
            exerciseSelect.addEventListener('change', () => {
                const exerciseType = exerciseSelect.value;
                socket.emit('change_exercise_type', { exercise_type: exerciseType });
                console.log('发送更改运动类型请求:', exerciseType);
                
                switch (exerciseType) {
                    case 'squat':
                        qualityTitle.textContent = '深蹲品質評分';
                        break;
                    case 'shoulder-press':
                        qualityTitle.textContent = '肩推品質評分';
                        break;
                    case 'bicep-curl':
                        qualityTitle.textContent = '二頭彎舉品質評分';
                        break;
                    case 'push-up':
                        qualityTitle.textContent = '俯卧撑品質評分';
                        break;
                    case 'pull-up':
                    qualityTitle.textContent = '俯卧撑品質評分';
                        break;
                    case 'pull-up':
                        qualityTitle.textContent = '引體向上品質評分';
                        break;
                    case 'dumbbell-row':
                        qualityTitle.textContent = '啞鈴划船品質評分';
                        break;
                    default:
                        qualityTitle.textContent = '品質評分';
                }
                
                if (qualityScore) {
                    qualityScore.textContent = '0';
                    qualityScore.style.color = '';
                }
                currentQualityScore = 0;
            });
            // 初始觸發一次 change 事件
            exerciseSelect.dispatchEvent(new Event('change'));
        }

        // 更新品質評分函數，支援 squat、shoulder-press 與 bicep-curl
        function updateQualityScore(event, data) {
            const currentExercise = exerciseSelect.value;
            const scoreEvents = {
                'squat': 'squat_quality',
                'shoulder-press': 'shoulder_press_score',
                'bicep-curl': 'bicep_curl_score'
            };
            
            if (event === scoreEvents[currentExercise] && qualityScore) {
                qualityScore.textContent = data.score;
                currentQualityScore = data.score;
                
                if (currentExercise === 'squat') {
                    if (data.score >= 4) {
                        qualityScore.style.color = '#FFFFFF';
                    } else if (data.score >= 3) {
                        qualityScore.style.color = '#FFC107';
                    } else {
                        qualityScore.style.color = '#F44336';
                    }
                } else if (currentExercise === 'shoulder-press') {
                    if (data.score >= 80) {
                        qualityScore.style.color = '#FFFFFF';
                    } else if (data.score >= 60) {
                        qualityScore.style.color = '#FFC107';
                    } else {
                        qualityScore.style.color = '#F44336';
                    }
                } else if (currentExercise === 'bicep-curl') {
                    if (data.score >= 80) {
                        qualityScore.style.color = '#FFFFFF';
                    } else if (data.score >= 60) {
                        qualityScore.style.color = '#FFC107';
                    } else {
                        qualityScore.style.color = '#F44336';
                    }
                }
                
                resetScoreTimer();
            }
        }

        // 重置分數計時器，如果長時間沒有更新分數則歸零
        function resetScoreTimer() {
            if (scoreResetTimer) {
                clearTimeout(scoreResetTimer);
            }
            
            scoreResetTimer = setTimeout(() => {
                if (qualityScore) {
                    qualityScore.textContent = '0';
                    qualityScore.style.color = '';
                }
                currentQualityScore = 0;
            }, SCORE_RESET_TIMEOUT);
        }

        // 更新教練提示函數
        function updateCoachTips(angleData) {
            let tips = '';
            const exerciseType = exerciseSelect.value;
            
            switch (exerciseType) {
                case 'squat':
                    tips = getSquatTips(angleData);
                    break;
                case 'shoulder-press':
                    tips = getShoulderPressTips(angleData);
                    break;
                case 'bicep-curl':
                    tips = getBicepCurlTips(angleData);
                    break;
                case 'push-up':
                    tips = getPushUpTips(angleData);
                    break;
                case 'pull-up':
                    tips = getPullUpTips(angleData);
                    break;
                case 'dumbbell-row':
                    tips = getDumbbellRowTips(angleData);
                    break;
                default:
                    tips = '請選擇運動類型並開始偵測以獲得即時建議。';
            }
            
            if (coachTipText) {
                coachTipText.textContent = tips || '請保持動作標準...';
            }
        }

        // 深蹲提示
        function getSquatTips(angleData) {
            if (!angleData) return '正在分析您的深蹲動作...';
            
            let tips = '';
            const kneeAngle = angleData['膝關節角度'] || 0;
            const hipAngle = angleData['髖關節角度'] || 0;
            const ankleAngle = angleData['踝關節角度'] || 0;
            
            if (kneeAngle < 90) {
                tips += '膝蓋彎曲過度，請注意不要讓膝蓋超過腳尖。\n';
            } else if (kneeAngle > 160) {
                tips += '膝蓋彎曲不足，請嘗試蹲得更深一些。\n';
            } else {
                tips += '膝蓋彎曲角度良好！\n';
            }
            
            if (hipAngle < 80) {
                tips += '髖部彎曲過度，請保持背部挺直。\n';
            } else if (hipAngle > 160) {
                tips += '髖部彎曲不足，請更加下蹲。\n';
            } else {
                tips += '髖部角度良好！\n';
            }
            
            if (ankleAngle < 70) {
                tips += '踝關節角度過小，請調整站姿。';
            } else if (ankleAngle > 110) {
                tips += '踝關節角度過大，請調整站姿。';
            } else {
                tips += '踝關節角度良好！';
            }
            
            return tips;
        }

        // 肩推提示
        function getShoulderPressTips(angleData) {
            if (!angleData) return '正在分析您的肩推動作...';
            
            let tips = '';
            const shoulderAngle = angleData['肩關節角度'] || 0;
            const elbowAngle = angleData['肘關節角度'] || 0;
            
            if (shoulderAngle < 80) {
                tips += '肩部抬起不足，請將啞鈴推高至頭頂上方。\n';
            } else if (shoulderAngle > 170) {
                tips += '肩部角度良好，啞鈴位置正確！\n';
            } else {
                tips += '繼續向上推，直到手臂完全伸直。\n';
            }
            
            if (elbowAngle < 90) {
                tips += '肘部彎曲過度，請注意起始姿勢。\n';
            } else if (elbowAngle > 170) {
                tips += '肘部伸展良好！\n';
            } else {
                tips += '肘部需要更加伸直，請完全推起啞鈴。\n';
            }
            
            return tips;
        }

        // 二頭彎舉提示
        function getBicepCurlTips(angleData) {
            if (!angleData) return '正在分析您的二頭彎舉動作...';
            
            let tips = '';
            const elbowAngle = angleData['肘關節角度'] || 0;
            const shoulderAngle = angleData['肩關節角度'] || 0;
            
            if (elbowAngle < 50) {
                tips += '肘部彎曲良好！\n';
            } else if (elbowAngle < 90) {
                tips += '繼續向上捲起啞鈴，使肘部角度更小。\n';
            } else {
                tips += '肘部彎曲不足，請將啞鈴舉得更高。\n';
            }
            
            if (shoulderAngle < 10 || shoulderAngle > 30) {
                tips += '請保持上臂固定，不要晃動肩膀。\n';
            } else {
                tips += '上臂位置良好，保持穩定！\n';
            }
            
            const now = Date.now();
            if (elbowAngle < 60 && bicep_state === "down") {
                bicep_state = "up";
                if (now - last_curl_time < 1000) {
                    tips += '動作過快，請放慢速度控制重量。';
                } else {
                    tips += '上舉動作良好！';
                }
                last_curl_time = now;
            } else if (elbowAngle > 150 && bicep_state === "up") {
                bicep_state = "down";
                if (now - last_curl_time < 1000) {
                    tips += '下放過快，請控制速度。';
                } else {
                    tips += '下放動作良好！';
                }
                last_curl_time = now;
            }
            
            return tips;
        }

        // 俯卧撑提示
        function getPushUpTips(angleData) {
            if (!angleData) return '正在分析您的俯卧撑動作...';
            
            let tips = '';
            const elbowAngle = angleData['肘關節角度'] || 0;
            const shoulderAngle = angleData['肩關節角度'] || 0;
            const hipAngle = angleData['髖關節角度'] || 0;
            
            if (elbowAngle < 90) {
                tips += '肘部彎曲良好，繼續保持！\n';
            } else {
                tips += '請更深入地下降，直到肘部彎曲90度。\n';
            }
            
            if (hipAngle < 160) {
                tips += '臀部下沉，請保持身體成一直線。\n';
            } else {
                tips += '身體姿勢良好，保持核心緊實！\n';
            }
            
            if (shoulderAngle < 30 || shoulderAngle > 45) {
                tips += '肩膀位置不正確，請調整手臂位置。';
            } else {
                tips += '肩膀位置良好！';
            }
            
            return tips;
        }

        // 引體向上提示
        function getPullUpTips(angleData) {
            if (!angleData) return '正在分析您的引體向上動作...';
            
            let tips = '';
            const elbowAngle = angleData['肘關節角度'] || 0;
            const shoulderAngle = angleData['肩關節角度'] || 0;
            
            if (elbowAngle < 60) {
                tips += '肘部彎曲良好，繼續上拉！\n';
            } else if (elbowAngle < 90) {
                tips += '繼續向上拉，直到下巴超過橫桿。\n';
            } else {
                tips += '請更用力向上拉，肘部需要更多彎曲。\n';
            }
            
            if (shoulderAngle > 160) {
                tips += '手臂完全伸展，準備向上拉起。\n';
            } else if (shoulderAngle < 90) {
                tips += '肩膀位置良好，繼續保持！\n';
            } else {
                tips += '請更多地收緊肩胛骨。\n';
            }
            
            return tips;
        }

        // 啞鈴划船提示
        function getDumbbellRowTips(angleData) {
            if (!angleData) return '正在分析您的啞鈴划船動作...';
            
            let tips = '';
            const elbowAngle = angleData['肘關節角度'] || 0;
            const shoulderAngle = angleData['肩關節角度'] || 0;
            const hipAngle = angleData['髖關節角度'] || 0;
            
            if (elbowAngle < 60) {
                tips += '肘部彎曲良好，啞鈴拉至腹部位置！\n';
            } else if (elbowAngle < 90) {
                tips += '繼續向上拉啞鈴，使肘部更加彎曲。\n';
            } else {
                tips += '肘部彎曲不足，請將啞鈴拉得更高。\n';
            }
            
            if (hipAngle < 100) {
                tips += '髖部彎曲良好，上半身保持平行於地面！\n';
            } else {
                tips += '請更多地前傾上半身，保持背部平直。\n';
            }
            
            if (shoulderAngle > 30) {
                tips += '肩膀過度抬起，請放鬆肩膀。';
            } else {
                tips += '肩膀位置良好，保持穩定！';
            }
            
            return tips;
        }

        // 更新怪物信息函数
        function updateMonsterInfo(data) {
            if (!monsterContainer) return;
            
            monsterContainer.innerHTML = `
                <h3 style="color:#8D6E63;margin:0 0 10px 0;font-size:18px;">🐲 怪物狀態</h3>
                <div style="margin-bottom:8px;"><strong>名稱:</strong> ${data.name || '未知'}</div>
                <div style="margin-bottom:8px;"><strong>健康值:</strong> 
                    <span style="color:${data.health < 30 ? '#F44336' : '#4CAF50'}">${data.health || 0}/100</span>
                </div>
                <div style="margin-bottom:8px;"><strong>經驗值:</strong> ${data.exp || 0}</div>
                <div style="margin-bottom:8px;"><strong>等級:</strong> ${data.level || 1}</div>
                <div><strong>狀態:</strong> ${data.status || '正常'}</div>
            `;
        }
    });
</script>



<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9199a4739c50827c',t:'MTc0MDg0MjQ2OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>