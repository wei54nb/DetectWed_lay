<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
  <title>NKUST - å³æ™‚å‹•ä½œåˆ†æ</title>
  <style>
      /* åŸºç¤è¨­ç½® */
      * {
          box-sizing: border-box;
          margin: 0;
          padding: 0;
          font-family: Arial, sans-serif;
          text-decoration: none;
          font-size: 16px;
      }

      body {
          margin: 0;
          background-color: #f4f4f4;
          overflow-x: hidden;
          min-height: 100vh;
      }

      .header {
          display: flex;
          flex-wrap: wrap;
          justify-content: space-between;
          align-items: center;
          background-color: #fff;
          padding: clamp(10px, 2vw, 20px);
          border-bottom: 2px solid #00BCD4;
          min-height: 80px;
      }

      .logo-container {
          display: flex;
          align-items: center;
          gap: clamp(15px, 2vw, 30px);
          flex-wrap: wrap;
      }

      .logo-container img {
          height: clamp(40px, 8vw, 80px);
          width: auto;
      }

      .logo-container span {
          font-size: clamp(1.2rem, 2vw, 2rem);
          font-weight: bold;
          color: #000;
      }

      .nav-buttons {
          display: flex;
          gap: clamp(10px, 2vw, 90px);
          flex-wrap: wrap;
      }

      .button {
          display: inline-block;
          padding: 0.75rem 1.5rem;
          border-radius: 0.5rem;
          color: #fff;
          text-transform: uppercase;
          font-size: clamp(0.8rem, 1.5vw, 1rem);
          letter-spacing: 0.15rem;
          transition: all 0.3s;
          position: relative;
          overflow: hidden;
          z-index: 1;
          text-align: center;
          background-color: #00BCD4;
          text-decoration: none;
          cursor: pointer;
          border: none;
          min-width: clamp(60px, 10vw, 120px);
      }

      .button:after {
          content: '';
          position: absolute;
          bottom: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: #00BCD4;
          border-radius: 0.5rem;
          z-index: -2;
      }

      .button:before {
          content: '';
          position: absolute;
          bottom: 0;
          left: 0;
          width: 0%;
          height: 100%;
          background-color: #0088cc;
          transition: all 0.3s;
          border-radius: 0.5rem;
          z-index: -1;
      }

      .button:hover {
          color: #fff;
      }

      .button:hover:before {
          width: 100%;
      }

      .content {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
          gap: clamp(10px, 2vw, 20px);
          padding: clamp(10px, 2vw, 20px);
          padding-bottom: 140px;
          max-width: 1600px;
          margin: 0 auto;
          position: relative;
      }

      .control-panel {
          display: flex;
          gap: 10px;
          flex-wrap: wrap;
          margin: 20px 0;
          position: relative;
          z-index: 100;
      }

      .control-panel .button,
      .control-panel select {
          min-width: 120px;
          margin: 5px;
      }

      .video-container {
          width: 100%;
          max-width: 560px;
          margin: 0 auto;
      }

      .video-container img,
      .video-container video {
          width: 100%;
          height: auto;
          max-height: 560px;
          object-fit: contain;
          border-radius: 8px;
      }

      .data-inputs {
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 30px;
          margin: 20px 0;
          max-width: 800px;
      }

      .data-inputs .input-group {
          display: flex;
          flex-direction: column;
          padding: 12px;
          background: rgba(0, 188, 212, 0.1);
          border-radius: 8px;
          height: auto;
          min-height: 65px;
      }

      .data-inputs .input-group label {
          font-size: 14px;
          color: #333;
          margin-bottom: 8px;
      }

      .data-inputs .input-group input {
          padding: 8px 12px;
          font-size: 14px;
          border: 1px solid #00BCD4;
          border-radius: 4px;
          width: 100%;
          height: 36px;
      }

      .angle-display {
          background-color: #333;
          padding: 15px;
          border-radius: 8px;
          color: #fff;
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
          gap: 10px;
          margin: 20px 0;
      }

      .angle-card {
          background-color: rgba(0, 188, 212, 0.1);
          border-radius: 5px;
          padding: 10px;
          text-align: center;
      }

      .angle-label {
          font-size: 14px;
          color: #00BCD4;
          margin-bottom: 5px;
      }

      .angle-value {
          font-size: 18px;
          font-weight: bold;
      }

      .exercise-counter {
          background-color: #00BCD4;
          color: white;
          padding: clamp(15px, 3vw, 20px);
          border-radius: 10px;
          margin: 20px 0;
          text-align: center;
      }

      .exercise-selector {
          padding: 0.75rem 1.5rem;
          border-radius: 0.5rem;
          border: 1px solid #00BCD4;
          font-size: clamp(0.8rem, 1.5vw, 1rem);
          background-color: white;
          cursor: pointer;
      }

      .counter-value {
          font-size: clamp(24px, 5vw, 48px);
          font-weight: bold;
          margin: 10px 0;
      }

      .counter-label {
          font-size: clamp(18px, 3vw, 24px);
      }

      .bottom-stats-container {
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          background: linear-gradient(to right, #00BCD4, #0097a7);
          padding: clamp(10px, 2vw, 15px);
          display: flex;
          flex-wrap: wrap;
          justify-content: center;
          gap: clamp(15px, 2vw, 30px);
          box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
          z-index: 1000;
          height: auto;
          max-height: 120px;
      }

      .stats-card {
          background: rgba(255, 255, 255, 0.1);
          padding: 15px 30px;
          border-radius: 10px;
          text-align: center;
          color: white;
          min-width: 200px;
          flex: 1;
          max-width: 300px;
      }

      .stats-label {
          font-size: clamp(14px, 2vw, 16px);
          margin-bottom: 5px;
          color: rgba(255, 255, 255, 0.9);
      }

      .stats-value {
          font-size: clamp(20px, 3vw, 28px);
          font-weight: bold;
      }

      .export-button {
          background: #4CAF50;
          color: white;
          padding: 10px 20px;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          transition: background 0.3s;
          font-size: clamp(14px, 2vw, 16px);
      }

      .export-button:hover {
          background: #45a049;
      }

      /* å„ªåŒ–å¾Œçš„æ•™ç·´æç¤ºè¦–çª—æ¨£å¼ */
      .coach-tip-container {
          position: fixed;
          left: 20px;
          bottom: 120px;
          width: clamp(250px, 50vw, 450px); /* Increased width */
          height: clamp(200px, 40vh, 300px); /* Added height */
          background: linear-gradient(135deg, #ffffff, #e6f2f4);
          border-radius: 15px;
          box-shadow: 0 10px 20px rgba(0, 0, 0, 0.12);
          border: 2px solid #00BCD4;
          overflow: hidden;
          display: flex;
          flex-direction: column;
      }

      .coach-tip-container:hover {
          transform: scale(1.02);
      }

      .coach-title {
          font-size: 22px;
          font-weight: 700;
          color: white;
          letter-spacing: 1px;
      }

      .coach-tip-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          background: #00BCD4;
          padding: 15px 20px;
      }

      .coach-tip-content {
          padding: 15px;
          display: flex;
          align-items: center;
          justify-content: center;
          height: calc(100% - 40px);
      }

      .coach-tip-text {
          font-size: 16px;
          line-height: 1.6;
          color: #333;
          font-weight: 600; /* Increased font weight for bolder text */
          background: rgba(255, 255, 255, 0.9);
          padding: 15px;
          border-radius: 10px;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          max-height: 150px;
          overflow-y: auto;
          text-align: left;
          white-space: pre-wrap;
          word-wrap: break-word;
          transition: background-color 0.3s ease;
      }

      .coach-tip-text:hover {
          background: rgba(0, 188, 212, 0.08);
      }


      .quality-display {
          display: flex;
          align-items: baseline;
          gap: 8px;
          background: rgba(255, 255, 255, 0.2);
          padding: 8px 15px;
          border-radius: 20px;
      }

      .quality-title {
          font-size: 16px;
          color: rgba(255, 255, 255, 0.9);
          font-weight: 600;
      }

      .quality-value {
          font-size: 28px;
          font-weight: 800;
          color: #FFEB3B;
      }

      .quality-max {
          font-size: 18px;
          color: rgba(255, 255, 255, 0.7);
      }

      .coach-tip-content {
          flex-grow: 1;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 25px;
          background: white;
      }


      /* åª’é«”æŸ¥è©¢ */
      @media (max-width: 768px) {
          .coach-tip-container {
              width: 90%;
              left: 5%;
              bottom: 100px;
          }

          .content {
              padding-bottom: 160px;
          }

          .control-panel {
              flex-direction: column;
              align-items: stretch;
          }

          .control-panel .button,
          .control-panel select {
              width: 100%;
              margin: 5px 0;
          }

          .header {
              flex-direction: column;
              gap: 15px;
              padding: 15px;
          }

          .nav-buttons {
              width: 100%;
              justify-content: center;
          }

          .bottom-stats-container {
              flex-direction: column;
              align-items: center;
          }

          .stats-card {
              width: 100%;
          }

          .coach-tip-text {
              font-size: 18px;
              font-weight: 600; /* Maintained bolder font weight */
              padding: 12px;
              max-height: 150px;
          }


      }

      @media (max-width: 480px) {
          .content {
              padding-bottom: 180px;
          }

          .bottom-stats-container {
              padding: 8px;
          }

          .logo-container {
              flex-direction: column;
              text-align: center;
          }

          .button {
              padding: 0.5rem 1rem;
              font-size: 0.9rem;
              width: 100%;
          }

          .data-inputs {
              grid-template-columns: 1fr;
          }

          .angle-display {
              grid-template-columns: 1fr;
          }

          .stats-card {
              padding: 8px;
              min-width: 150px;
          }


        /* æ–°å¢/ä¿®æ”¹CSSæ ·å¼ */
        .coach-tip-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #00BCD4;
            padding: 12px 20px;
            border-bottom: 2px solid #0088cc;
        }

        .coach-title {
            font-size: 20px;
        }

          .quality-display {
              display: flex;
              align-items: baseline;
              gap: 8px;
              background: rgba(255, 255, 255, 0.2);
              padding: 8px 15px;
              border-radius: 20px;
          }

          .quality-title {
              font-size: 16px;
              color: rgba(255, 255, 255, 0.9);
              font-weight: 600;
          }


          /* å­—ä½“å¤§å°ä¼˜åŒ– */
        .score-title {
          font-size: 1.4rem !important;
          color: #fff !important;
          margin-bottom: 8px;
          letter-spacing: 1px;
        }

        .score-value {
          font-size: 2.8rem !important;
          font-weight: 800 !important;
          color: #FFEB3B !important;
          text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
          line-height: 1;
        }

        .score-max {
          font-size: 1.2rem !important;
          color: rgba(255, 255, 255, 0.8) !important;
          margin-left: 5px;
        }

        /* æ•™ç·´è¦–çª—ä½ç½®å¾®è°ƒ */
          .coach-tip-container {
              left: 5%;
              bottom: 80px;
              width: 90%;
              height: auto;
          }

          .quality-value {
              font-size: 28px;
              font-weight: 800;
              color: #FFEB3B;
          }

          .quality-max {
              font-size: 18px;
              color: rgba(255, 255, 255, 0.7);
          }

        /* è°ƒæ•´æ•´ä½“å®¹å™¨é«˜åº¦ */
        .coach-tip-content {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 25px;
            background: white;
        }


        .quality-score {
            font-size: clamp(24px, 5vw, 48px);
            font-weight: bold;
        }

          .coach-tip-text {
              font-size: 16px;
          }

      }
    add text after this line
    .monster-display {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #ffe0b2;
        border: 2px solid #f57c00;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        padding: 15px;
        z-index: 2000;
        font-family: Arial, sans-serif;
        color: #4e342e;
        font-size: 14px;
    }
    </style>
</head>

<body>
<div class="header">
    <div class="logo-container">
        <img src="{{ url_for('static', filename='img/nkust.png') }}" alt="NKUST Logo">
        <span>åœ‹ç«‹é«˜é›„ç§‘æŠ€å¤§å­¸</span>
    </div>
    <div class="nav-buttons">
        <a href="{{ url_for('main.index') }}" class="button">å›é¦–é </a>
        <button class="button">å‹•ä½œçŸ¥è­˜</button>
        <button class="button">å™¨æä»‹ç´¹</button>
    </div>
</div>

<div class="content">
    <div class="bottom-stats-container">
        <div class="stats-card">
            <div class="stats-label">å®Œæˆæ¬¡æ•¸</div>
            <div class="stats-value" id="exercise-count-stats">0</div>
        </div>
        <button id="export-excel" class="export-button">å°å‡ºæˆ°ç¸¾</button>
    </div>

    <div class="data-inputs">
        <div class="input-group">
            <label for="student-id">å­¸ç”ŸID</label>
            <input type="text" id="student-id" placeholder="è«‹è¼¸å…¥å­¸è™Ÿ">
        </div>
        <div class="input-group">
            <label for="weight">é‡é‡(Kg)</label>
            <input type="number" id="weight" placeholder="è«‹è¼¸å…¥é‡é‡">
        </div>
        <div class="input-group">
            <label for="sets">çµ„æ•¸</label>
            <input type="number" id="sets" placeholder="è«‹è¼¸å…¥çµ„æ•¸">
        </div>
        <div class="input-group">
            <label for="reps">æ¯çµ„æ¬¡æ•¸</label>
            <input type="number" id="reps" placeholder="è«‹è¼¸å…¥æ¯çµ„æ¬¡æ•¸">
        </div>
    </div>

    <div class="video-container">
        <img id="video-feed" src="{{ url_for('exercise.video_feed') }}" alt="Real-time Video Feed">
    </div>

    <div class="data-container">
        <h2>å³æ™‚æ•¸æ“š</h2>
        <div class="exercise-counter">
            <div class="counter-label">é‹å‹•æ¬¡æ•¸</div>
            <div class="counter-value" id="exercise-count">0</div>
            
        </div>
        <div class="exercise-counter">
            <div class="counter-label">å‰©é¤˜çµ„æ•¸</div>
            <div class="counter-value" id="remaining-sets">0</div>
        </div>

        <div class="control-panel">
            <select id="exercise-type" class="exercise-selector">
                <option value="squat">æ·±è¹²è¨“ç·´</option>
                <option value="bicep-curl">äºŒé ­è¨“ç·´</option>
                <option value="shoulder-press">è‚©æ¨è¨“ç·´</option>
                <option value="push-up">ä¼åœ°æŒºèº«</option>
                <option value="pull-up">å¼•é«”å‘ä¸Š</option>
                <option value="dumbbell-row">å•éˆ´åˆ’èˆ¹</option>
            </select>
            <button id="start-detection" class="button">é–‹å§‹åµæ¸¬</button>
            <button id="stop-detection" class="button">åœæ­¢åµæ¸¬</button>
        </div>
        <div class="angle-display">
            <!-- è§’åº¦æ•¸æ“šå°‡åœ¨é€™è£¡å‹•æ…‹æ›´æ–° -->
        </div>

        <!-- æ•™ç·´æç¤ºè¦–çª—æ”¾åœ¨å·¦ä¸‹è§’ -->
        <div class="coach-tip-container">
            <div class="coach-tip-header">
                <div class="coach-title">å³æ™‚å¥èº«æ•™ç·´</div>
                <div class="quality-display">
                    <div class="quality-title">å“è³ªè©•åˆ†</div>
                    <div class="quality-value">0</div>
                    <div class="quality-max">/5</div>
                </div>
            </div>
            <div class="coach-tip-content">
                <div class="coach-tip-text">
                    è«‹é¸æ“‡é‹å‹•é¡å‹ä¸¦é–‹å§‹åµæ¸¬ä»¥ç²å¾—å³æ™‚å»ºè­°ã€‚
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // ä½¿ç”¨æ­£ç¡®çš„å‘½åç©ºé—´è¿æ¥
        const startButton = document.getElementById('start-detection');
        const stopButton = document.getElementById('stop-detection');
        const exerciseSelect = document.getElementById('exercise-type');
        const videoFeed = document.getElementById('video-feed');
        const exerciseCount = document.getElementById('exercise-count');
        const exerciseCountStats = document.getElementById('exercise-count-stats');
        const remainingSetsDisplay = document.getElementById('remaining-sets');
        const coachTipText = document.querySelector('.coach-tip-text');
        const qualityScore = document.querySelector('.quality-value');
        const qualityTitle = document.querySelector('.quality-title');
        const qualityDisplay = document.querySelector('.quality-display');
        const setDetectionLineButton = document.getElementById('set-detection-line');
        const resetCountButton = document.getElementById('reset-count');
        const exportExcelButton = document.getElementById('export-excel');
        const socket = io.connect('/exercise');
        
        // åˆ›å»ºæ€ªç‰©å®¹å™¨
        const monsterContainer = document.createElement('div');
        monsterContainer.id = 'monster-container';
        monsterContainer.classList.add('monster-display');
        document.body.appendChild(monsterContainer);
        
        // æ€ªç‰©äº‹ä»¶ç›‘å¬
        socket.on('monster_event', (data) => {
            try {
                updateMonsterInfo(data);
                if (data.health && data.health < 20) {
                    alert('è­¦å‘Šï¼šæ€ªç‰©å¥åº·å€¼éä½ï¼');
                }
            } catch (error) {
                console.error('è™•ç†æ€ªç‰©æ•¸æ“šéŒ¯èª¤:', error);
                alert('ç„¡æ³•æ›´æ–°æ€ªç‰©è³‡è¨Šï¼Œè«‹ç¨å¾Œå†è©¦ï¼');
            }
        });

        // ç¢ºä¿æ‰€æœ‰é—œéµå…ƒç´ å­˜åœ¨çš„æª¢æŸ¥
        const requiredElements = [
            {element: startButton, name: 'é–‹å§‹åµæ¸¬æŒ‰éˆ•'},
            {element: stopButton, name: 'åœæ­¢åµæ¸¬æŒ‰éˆ•'},
            {element: exerciseSelect, name: 'é‹å‹•é¡å‹é¸æ“‡'},
            {element: videoFeed, name: 'è¦–é »æº'},
            {element: exerciseCount, name: 'é‹å‹•æ¬¡æ•¸é¡¯ç¤º'},
            {element: coachTipText, name: 'æ•™ç·´æç¤ºæ–‡æœ¬'}
        ];

        const missingElements = requiredElements.filter(item => !item.element);
        if (missingElements.length > 0) {
            console.error('ä»¥ä¸‹å…ƒç´ æœªæ‰¾åˆ°:', missingElements.map(item => item.name).join(', '));
            alert('é é¢åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°è¼‰å…¥é é¢');
            return;
        }

        // è¨­å®šåˆå§‹æŒ‰éˆ•ç‹€æ…‹
        startButton.disabled = false;
        stopButton.disabled = true;

        // åˆå§‹åŒ–è®Šæ•¸
        let exerciseReps = 0;
        let remainingSets = 0;
        let detectionLineY = null;
        let currentQualityScore = 0;
        let scoreResetTimer = null;
        const SCORE_RESET_TIMEOUT = 10000; // 10ç§’å¾Œç„¡æ›´æ–°å‰‡æ­¸é›¶

        // å…¨åŸŸè®Šæ•¸ï¼Œç”¨æ–¼äºŒé ­å½èˆ‰è¨˜æ•¸ç‹€æ…‹
        let bicep_state = "down";
        let last_curl_time = 0;

        // Socket.IO äº‹ä»¶è™•ç†
        socket.on('connect', () => {
            console.log('å·²é€£æ¥åˆ° Socket.IO ä¼ºæœå™¨');
            if (document.getElementById('connection-status')) {
                document.getElementById('connection-status').textContent = 'å·²è¿æ¥';
                document.getElementById('connection-status').style.color = 'green';
            }
        });

        socket.on('disconnect', () => {
            console.log('ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥');
            if (document.getElementById('connection-status')) {
                document.getElementById('connection-status').textContent = 'å·²æ–­å¼€';
                document.getElementById('connection-status').style.color = 'red';
            }
        });

        socket.on('video_frame', (data) => {
            if (videoFeed) {
                videoFeed.src = 'data:image/jpeg;base64,' + data.frame;
            }
        });

        socket.on('exercise_count', (data) => {
            if (exerciseCount) {
                exerciseCount.textContent = data.count;
            }
            
            // å¦‚æœæœ‰è´¨é‡è¯„åˆ†ï¼Œæ›´æ–°è´¨é‡è¯„åˆ†
            if (data.quality !== undefined && document.getElementById('quality-score')) {
                document.getElementById('quality-score').textContent = data.quality;
            }
        });

        // ç›£è½å„é‹å‹•è©•åˆ†äº‹ä»¶
        socket.on('squat_quality', (data) => {
            console.log("æ”¶åˆ°æ·±è¹²å“è³ªè©•åˆ†æ•¸æ“š:", data);
            if (!data || typeof data.score === 'undefined') {
                console.error("æ·±è¹²å“è³ªè©•åˆ†æ•¸æ“šæ ¼å¼ä¸æ­£ç¢º:", data);
                return;
            }
            updateQualityScore('squat_quality', data);
        });

        socket.on('shoulder_press_score', (data) => {
            console.log("Received shoulder_press_score:", data);
            updateQualityScore('shoulder_press_score', data);
        });

        socket.on('bicep_curl_score', (data) => {
            console.log("Received bicep_curl_score:", data);
            updateQualityScore('bicep_curl_score', data);
        });

        socket.on('exercise_count_update', (data) => {
            console.log("Received exercise_count_update:", data);
            exerciseCount.textContent = data.count;
            exerciseCountStats.textContent = data.count;
            exerciseReps++;
            const repsGoal = parseInt(document.getElementById('reps').value) || 0;
            if (repsGoal > 0 && exerciseReps >= repsGoal && remainingSets > 0) {
                exerciseReps = 0;
                remainingSets--;
                remainingSetsDisplay.textContent = remainingSets;
                if (remainingSets <= 0) {
                    alert("å·²å®Œæˆæ‰€æœ‰çµ„æ•¸ï¼");
                    stopButton.click();
                }
            }
        });

        socket.on('angle_data', (data) => {
            console.log("æ”¶åˆ°è§’åº¦æ•¸æ“š:", data);
                if (!data || Object.keys(data).length === 0) {
                    console.error("è§’åº¦æ•¸æ“šç‚ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¢º");
                    return;
                }
                // æ›´æ–°è§’åº¦é¡¯ç¤º
                const angleDisplay = document.querySelector('.angle-display');
                if (angleDisplay) {
                    angleDisplay.innerHTML = "";
                    for (let key in data) {
                        const angleElement = document.createElement("div");
                        angleElement.classList.add("angle-card");
                        angleElement.innerHTML = `<div class="angle-label">${key}</div>
                                            <div class="angle-value">${data[key].toFixed(1)}Â°</div>`;
                        angleDisplay.appendChild(angleElement);
                    }
                    // ç¢ºä¿èª¿ç”¨æ•™ç·´æç¤ºæ›´æ–°å‡½æ•¸
                    updateCoachTips(data);
                }
            });

        socket.on('detection_line_set', (data) => {
            if (data.error) {
                alert(`è¨­ç½®åµæ¸¬ç·šå¤±æ•—ï¼š${data.error}`);
            } else {
                detectionLineY = data.detection_line_y;
                alert(`åµæ¸¬ç·šå·²è¨­å®šå®Œæˆï¼ä½ç½®ï¼š${detectionLineY}px`);
            }
        });

        // é–‹å§‹åµæ¸¬æŒ‰éˆ•äº‹ä»¶
        if (startButton) {
            function handleFetchError(error, context) {
                console.error(`${context} éŒ¯èª¤:`, error);
                alert(`${context}å¤±æ•—ï¼š${error.message || 'æœªçŸ¥éŒ¯èª¤'}`);
            }

            startButton.addEventListener('click', () => {
                const exerciseType = exerciseSelect.value;
                const weight = document.getElementById('weight').value;
                const reps = document.getElementById('reps').value;
                const sets = document.getElementById('sets').value;
                const studentId = document.getElementById('student-id').value;

                console.log("é–‹å§‹åµæ¸¬ - ç™¼é€è«‹æ±‚åƒæ•¸:", {exerciseType, weight, reps, sets, studentId});
                fetch(`/exercise/start_detection?exercise_type=${exerciseType}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({weight, reps, sets, student_id: studentId})
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('å¾Œç«¯å›æ‡‰å¤±æ•—');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        startButton.disabled = true;
                        stopButton.disabled = false;
                        exerciseCount.textContent = '0';
                        exerciseReps = 0;
                        remainingSets = parseInt(sets) || 0;
                        remainingSetsDisplay.textContent = remainingSets;
                        videoFeed.src = `/exercise/video_feed?t=${new Date().getTime()}`;
                        coachTipText.textContent = 'æ­£åœ¨åµæ¸¬ï¼Œè«‹ä¿æŒå‹•ä½œæ¨™æº–...';

                        // é‡ç½®å“è³ªè©•åˆ†
                        if (qualityScore) {
                            qualityScore.textContent = '0';
                            qualityScore.style.color = '';
                        }
                        currentQualityScore = 0;

                        // æ ¹æ“šé‹å‹•é¡å‹é¡¯ç¤º/éš±è—å“è³ªè©•åˆ†
                        if (qualityDisplay) {
                            qualityDisplay.style.display = (exerciseType === 'squat' || exerciseType === 'shoulder-press' || exerciseType === 'bicep-curl') ? 'block' : 'none';
                        }

                        resetScoreTimer();
                    } else {
                        throw new Error('å¾Œç«¯å›æ‡‰å¤±æ•—');
                    }
                })
                .catch(error => {
                    console.error('é–‹å§‹åµæ¸¬éŒ¯èª¤:', error);
                    alert(`å•Ÿå‹•åµæ¸¬å¤±æ•—: ${error.message}`);
                });
            });
        }

        // åœæ­¢åµæ¸¬æŒ‰éˆ•äº‹ä»¶
        if (stopButton) {
            stopButton.addEventListener('click', () => {
                console.log("åœæ­¢åµæ¸¬ - ç™¼é€è«‹æ±‚");
                fetch('/exercise/stop_detection', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                })
                .then(response => {
                    if (!response.ok) throw new Error('åœæ­¢åµæ¸¬å¤±æ•—');
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        startButton.disabled = false;
                        stopButton.disabled = true;
                        videoFeed.src = '';
                        coachTipText.textContent = 'åµæ¸¬å·²åœæ­¢ï¼Œè«‹é‡æ–°é–‹å§‹ä»¥ç²å¾—å»ºè­°ã€‚';
                        exerciseReps = 0;
                        remainingSets = 0;
                        remainingSetsDisplay.textContent = '0';

                        if (scoreResetTimer) {
                            clearTimeout(scoreResetTimer);
                            scoreResetTimer = null;
                        }

                        if (qualityScore) {
                            qualityScore.textContent = '0';
                            qualityScore.style.color = '';
                        }
                        currentQualityScore = 0;
                    } else {
                        throw new Error('å¾Œç«¯å›æ‡‰å¤±æ•—');
                    }
                })
                .catch(error => {
                    console.error('åœæ­¢åµæ¸¬éŒ¯èª¤:', error);
                    alert(`åœæ­¢åµæ¸¬å¤±æ•—: ${error.message}`);
                });
            });
        }

        // è¨­ç½®åµæ¸¬ç·šæŒ‰éˆ•äº‹ä»¶
        if (setDetectionLineButton) {
            setDetectionLineButton.addEventListener('click', () => {
                socket.emit('set_detection_line');
                alert('æ­£åœ¨å•Ÿå‹•æ”åƒæ©Ÿä¸¦è¨­ç½®åµæ¸¬ç·šï¼Œè«‹åœ¨é¡é ­å‰ä¿æŒç«™ç«‹å§¿å‹¢ï¼Œç³»çµ±å°‡æ ¹æ“šæ‚¨çš„é«–é—œç¯€ä½ç½®è¨­ç½®åµæ¸¬ç·š');
                videoFeed.src = `/video_feed?t=${new Date().getTime()}`;
            });
        }

        // é‡ç½®è®¡æ•°æŒ‰é’®äº‹ä»¶
        if (resetCountButton) {
            resetCountButton.addEventListener('click', () => {
                socket.emit('reset_count');
                console.log('å‘é€é‡ç½®è®¡æ•°è¯·æ±‚');
            });
        }
        
        // å¯¼å‡ºExcelæŒ‰é’®äº‹ä»¶
        if (exportExcelButton) {
            exportExcelButton.addEventListener('click', () => {
                const studentId = document.getElementById('student-id').value;
                const exerciseType = exerciseSelect.value;
                const weight = document.getElementById('weight').value;
                const count = exerciseCount.textContent;
                
                if (!studentId) {
                    alert('è«‹å…ˆè¼¸å…¥å­¸è™Ÿ');
                    return;
                }
                
                console.log('å¯¼å‡ºExcelæ•°æ®:', {studentId, exerciseType, weight, count});
                
                fetch('/exercise/export_data', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        student_id: studentId,
                        exercise_type: exerciseType,
                        weight: weight,
                        count: count
                    })
                })
                .then(response => {
                    if (!response.ok) throw new Error('å°å‡ºæ•¸æ“šå¤±æ•—');
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `exercise_data_${studentId}_${new Date().toISOString().slice(0,10)}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    alert('æ•¸æ“šå°å‡ºæˆåŠŸï¼');
                })
                .catch(error => {
                    console.error('å°å‡ºæ•¸æ“šéŒ¯èª¤:', error);
                    alert(`å°å‡ºæ•¸æ“šå¤±æ•—: ${error.message}`);
                });
            });
        }

        // é‹å‹•é¡å‹è®Šæ›´æ™‚æ›´æ–°å“è³ªè©•åˆ†æ¨™é¡Œå’Œé‡ç½®åˆ†æ•¸
        if (exerciseSelect) {
            exerciseSelect.addEventListener('change', () => {
                const exerciseType = exerciseSelect.value;
                socket.emit('change_exercise_type', { exercise_type: exerciseType });
                console.log('å‘é€æ›´æ”¹è¿åŠ¨ç±»å‹è¯·æ±‚:', exerciseType);
                
                switch (exerciseType) {
                    case 'squat':
                        qualityTitle.textContent = 'æ·±è¹²å“è³ªè©•åˆ†';
                        break;
                    case 'shoulder-press':
                        qualityTitle.textContent = 'è‚©æ¨å“è³ªè©•åˆ†';
                        break;
                    case 'bicep-curl':
                        qualityTitle.textContent = 'äºŒé ­å½èˆ‰å“è³ªè©•åˆ†';
                        break;
                    case 'push-up':
                        qualityTitle.textContent = 'ä¿¯å§æ’‘å“è³ªè©•åˆ†';
                        break;
                    case 'pull-up':
                    qualityTitle.textContent = 'ä¿¯å§æ’‘å“è³ªè©•åˆ†';
                        break;
                    case 'pull-up':
                        qualityTitle.textContent = 'å¼•é«”å‘ä¸Šå“è³ªè©•åˆ†';
                        break;
                    case 'dumbbell-row':
                        qualityTitle.textContent = 'å•éˆ´åˆ’èˆ¹å“è³ªè©•åˆ†';
                        break;
                    default:
                        qualityTitle.textContent = 'å“è³ªè©•åˆ†';
                }
                
                if (qualityScore) {
                    qualityScore.textContent = '0';
                    qualityScore.style.color = '';
                }
                currentQualityScore = 0;
            });
            // åˆå§‹è§¸ç™¼ä¸€æ¬¡ change äº‹ä»¶
            exerciseSelect.dispatchEvent(new Event('change'));
        }

        // æ›´æ–°å“è³ªè©•åˆ†å‡½æ•¸ï¼Œæ”¯æ´ squatã€shoulder-press èˆ‡ bicep-curl
        function updateQualityScore(event, data) {
            const currentExercise = exerciseSelect.value;
            const scoreEvents = {
                'squat': 'squat_quality',
                'shoulder-press': 'shoulder_press_score',
                'bicep-curl': 'bicep_curl_score'
            };
            
            if (event === scoreEvents[currentExercise] && qualityScore) {
                qualityScore.textContent = data.score;
                currentQualityScore = data.score;
                
                if (currentExercise === 'squat') {
                    if (data.score >= 4) {
                        qualityScore.style.color = '#FFFFFF';
                    } else if (data.score >= 3) {
                        qualityScore.style.color = '#FFC107';
                    } else {
                        qualityScore.style.color = '#F44336';
                    }
                } else if (currentExercise === 'shoulder-press') {
                    if (data.score >= 80) {
                        qualityScore.style.color = '#FFFFFF';
                    } else if (data.score >= 60) {
                        qualityScore.style.color = '#FFC107';
                    } else {
                        qualityScore.style.color = '#F44336';
                    }
                } else if (currentExercise === 'bicep-curl') {
                    if (data.score >= 80) {
                        qualityScore.style.color = '#FFFFFF';
                    } else if (data.score >= 60) {
                        qualityScore.style.color = '#FFC107';
                    } else {
                        qualityScore.style.color = '#F44336';
                    }
                }
                
                resetScoreTimer();
            }
        }

        // é‡ç½®åˆ†æ•¸è¨ˆæ™‚å™¨ï¼Œå¦‚æœé•·æ™‚é–“æ²’æœ‰æ›´æ–°åˆ†æ•¸å‰‡æ­¸é›¶
        function resetScoreTimer() {
            if (scoreResetTimer) {
                clearTimeout(scoreResetTimer);
            }
            
            scoreResetTimer = setTimeout(() => {
                if (qualityScore) {
                    qualityScore.textContent = '0';
                    qualityScore.style.color = '';
                }
                currentQualityScore = 0;
            }, SCORE_RESET_TIMEOUT);
        }

        // æ›´æ–°æ•™ç·´æç¤ºå‡½æ•¸
        function updateCoachTips(angleData) {
            let tips = '';
            const exerciseType = exerciseSelect.value;
            
            switch (exerciseType) {
                case 'squat':
                    tips = getSquatTips(angleData);
                    break;
                case 'shoulder-press':
                    tips = getShoulderPressTips(angleData);
                    break;
                case 'bicep-curl':
                    tips = getBicepCurlTips(angleData);
                    break;
                case 'push-up':
                    tips = getPushUpTips(angleData);
                    break;
                case 'pull-up':
                    tips = getPullUpTips(angleData);
                    break;
                case 'dumbbell-row':
                    tips = getDumbbellRowTips(angleData);
                    break;
                default:
                    tips = 'è«‹é¸æ“‡é‹å‹•é¡å‹ä¸¦é–‹å§‹åµæ¸¬ä»¥ç²å¾—å³æ™‚å»ºè­°ã€‚';
            }
            
            if (coachTipText) {
                coachTipText.textContent = tips || 'è«‹ä¿æŒå‹•ä½œæ¨™æº–...';
            }
        }

        // æ·±è¹²æç¤º
        function getSquatTips(angleData) {
            if (!angleData) return 'æ­£åœ¨åˆ†ææ‚¨çš„æ·±è¹²å‹•ä½œ...';
            
            let tips = '';
            const kneeAngle = angleData['è†é—œç¯€è§’åº¦'] || 0;
            const hipAngle = angleData['é«–é—œç¯€è§’åº¦'] || 0;
            const ankleAngle = angleData['è¸é—œç¯€è§’åº¦'] || 0;
            
            if (kneeAngle < 90) {
                tips += 'è†è“‹å½æ›²éåº¦ï¼Œè«‹æ³¨æ„ä¸è¦è®“è†è“‹è¶…éè…³å°–ã€‚\n';
            } else if (kneeAngle > 160) {
                tips += 'è†è“‹å½æ›²ä¸è¶³ï¼Œè«‹å˜—è©¦è¹²å¾—æ›´æ·±ä¸€äº›ã€‚\n';
            } else {
                tips += 'è†è“‹å½æ›²è§’åº¦è‰¯å¥½ï¼\n';
            }
            
            if (hipAngle < 80) {
                tips += 'é«–éƒ¨å½æ›²éåº¦ï¼Œè«‹ä¿æŒèƒŒéƒ¨æŒºç›´ã€‚\n';
            } else if (hipAngle > 160) {
                tips += 'é«–éƒ¨å½æ›²ä¸è¶³ï¼Œè«‹æ›´åŠ ä¸‹è¹²ã€‚\n';
            } else {
                tips += 'é«–éƒ¨è§’åº¦è‰¯å¥½ï¼\n';
            }
            
            if (ankleAngle < 70) {
                tips += 'è¸é—œç¯€è§’åº¦éå°ï¼Œè«‹èª¿æ•´ç«™å§¿ã€‚';
            } else if (ankleAngle > 110) {
                tips += 'è¸é—œç¯€è§’åº¦éå¤§ï¼Œè«‹èª¿æ•´ç«™å§¿ã€‚';
            } else {
                tips += 'è¸é—œç¯€è§’åº¦è‰¯å¥½ï¼';
            }
            
            return tips;
        }

        // è‚©æ¨æç¤º
        function getShoulderPressTips(angleData) {
            if (!angleData) return 'æ­£åœ¨åˆ†ææ‚¨çš„è‚©æ¨å‹•ä½œ...';
            
            let tips = '';
            const shoulderAngle = angleData['è‚©é—œç¯€è§’åº¦'] || 0;
            const elbowAngle = angleData['è‚˜é—œç¯€è§’åº¦'] || 0;
            
            if (shoulderAngle < 80) {
                tips += 'è‚©éƒ¨æŠ¬èµ·ä¸è¶³ï¼Œè«‹å°‡å•éˆ´æ¨é«˜è‡³é ­é ‚ä¸Šæ–¹ã€‚\n';
            } else if (shoulderAngle > 170) {
                tips += 'è‚©éƒ¨è§’åº¦è‰¯å¥½ï¼Œå•éˆ´ä½ç½®æ­£ç¢ºï¼\n';
            } else {
                tips += 'ç¹¼çºŒå‘ä¸Šæ¨ï¼Œç›´åˆ°æ‰‹è‡‚å®Œå…¨ä¼¸ç›´ã€‚\n';
            }
            
            if (elbowAngle < 90) {
                tips += 'è‚˜éƒ¨å½æ›²éåº¦ï¼Œè«‹æ³¨æ„èµ·å§‹å§¿å‹¢ã€‚\n';
            } else if (elbowAngle > 170) {
                tips += 'è‚˜éƒ¨ä¼¸å±•è‰¯å¥½ï¼\n';
            } else {
                tips += 'è‚˜éƒ¨éœ€è¦æ›´åŠ ä¼¸ç›´ï¼Œè«‹å®Œå…¨æ¨èµ·å•éˆ´ã€‚\n';
            }
            
            return tips;
        }

        // äºŒé ­å½èˆ‰æç¤º
        function getBicepCurlTips(angleData) {
            if (!angleData) return 'æ­£åœ¨åˆ†ææ‚¨çš„äºŒé ­å½èˆ‰å‹•ä½œ...';
            
            let tips = '';
            const elbowAngle = angleData['è‚˜é—œç¯€è§’åº¦'] || 0;
            const shoulderAngle = angleData['è‚©é—œç¯€è§’åº¦'] || 0;
            
            if (elbowAngle < 50) {
                tips += 'è‚˜éƒ¨å½æ›²è‰¯å¥½ï¼\n';
            } else if (elbowAngle < 90) {
                tips += 'ç¹¼çºŒå‘ä¸Šæ²èµ·å•éˆ´ï¼Œä½¿è‚˜éƒ¨è§’åº¦æ›´å°ã€‚\n';
            } else {
                tips += 'è‚˜éƒ¨å½æ›²ä¸è¶³ï¼Œè«‹å°‡å•éˆ´èˆ‰å¾—æ›´é«˜ã€‚\n';
            }
            
            if (shoulderAngle < 10 || shoulderAngle > 30) {
                tips += 'è«‹ä¿æŒä¸Šè‡‚å›ºå®šï¼Œä¸è¦æ™ƒå‹•è‚©è†€ã€‚\n';
            } else {
                tips += 'ä¸Šè‡‚ä½ç½®è‰¯å¥½ï¼Œä¿æŒç©©å®šï¼\n';
            }
            
            const now = Date.now();
            if (elbowAngle < 60 && bicep_state === "down") {
                bicep_state = "up";
                if (now - last_curl_time < 1000) {
                    tips += 'å‹•ä½œéå¿«ï¼Œè«‹æ”¾æ…¢é€Ÿåº¦æ§åˆ¶é‡é‡ã€‚';
                } else {
                    tips += 'ä¸Šèˆ‰å‹•ä½œè‰¯å¥½ï¼';
                }
                last_curl_time = now;
            } else if (elbowAngle > 150 && bicep_state === "up") {
                bicep_state = "down";
                if (now - last_curl_time < 1000) {
                    tips += 'ä¸‹æ”¾éå¿«ï¼Œè«‹æ§åˆ¶é€Ÿåº¦ã€‚';
                } else {
                    tips += 'ä¸‹æ”¾å‹•ä½œè‰¯å¥½ï¼';
                }
                last_curl_time = now;
            }
            
            return tips;
        }

        // ä¿¯å§æ’‘æç¤º
        function getPushUpTips(angleData) {
            if (!angleData) return 'æ­£åœ¨åˆ†ææ‚¨çš„ä¿¯å§æ’‘å‹•ä½œ...';
            
            let tips = '';
            const elbowAngle = angleData['è‚˜é—œç¯€è§’åº¦'] || 0;
            const shoulderAngle = angleData['è‚©é—œç¯€è§’åº¦'] || 0;
            const hipAngle = angleData['é«–é—œç¯€è§’åº¦'] || 0;
            
            if (elbowAngle < 90) {
                tips += 'è‚˜éƒ¨å½æ›²è‰¯å¥½ï¼Œç¹¼çºŒä¿æŒï¼\n';
            } else {
                tips += 'è«‹æ›´æ·±å…¥åœ°ä¸‹é™ï¼Œç›´åˆ°è‚˜éƒ¨å½æ›²90åº¦ã€‚\n';
            }
            
            if (hipAngle < 160) {
                tips += 'è‡€éƒ¨ä¸‹æ²‰ï¼Œè«‹ä¿æŒèº«é«”æˆä¸€ç›´ç·šã€‚\n';
            } else {
                tips += 'èº«é«”å§¿å‹¢è‰¯å¥½ï¼Œä¿æŒæ ¸å¿ƒç·Šå¯¦ï¼\n';
            }
            
            if (shoulderAngle < 30 || shoulderAngle > 45) {
                tips += 'è‚©è†€ä½ç½®ä¸æ­£ç¢ºï¼Œè«‹èª¿æ•´æ‰‹è‡‚ä½ç½®ã€‚';
            } else {
                tips += 'è‚©è†€ä½ç½®è‰¯å¥½ï¼';
            }
            
            return tips;
        }

        // å¼•é«”å‘ä¸Šæç¤º
        function getPullUpTips(angleData) {
            if (!angleData) return 'æ­£åœ¨åˆ†ææ‚¨çš„å¼•é«”å‘ä¸Šå‹•ä½œ...';
            
            let tips = '';
            const elbowAngle = angleData['è‚˜é—œç¯€è§’åº¦'] || 0;
            const shoulderAngle = angleData['è‚©é—œç¯€è§’åº¦'] || 0;
            
            if (elbowAngle < 60) {
                tips += 'è‚˜éƒ¨å½æ›²è‰¯å¥½ï¼Œç¹¼çºŒä¸Šæ‹‰ï¼\n';
            } else if (elbowAngle < 90) {
                tips += 'ç¹¼çºŒå‘ä¸Šæ‹‰ï¼Œç›´åˆ°ä¸‹å·´è¶…éæ©«æ¡¿ã€‚\n';
            } else {
                tips += 'è«‹æ›´ç”¨åŠ›å‘ä¸Šæ‹‰ï¼Œè‚˜éƒ¨éœ€è¦æ›´å¤šå½æ›²ã€‚\n';
            }
            
            if (shoulderAngle > 160) {
                tips += 'æ‰‹è‡‚å®Œå…¨ä¼¸å±•ï¼Œæº–å‚™å‘ä¸Šæ‹‰èµ·ã€‚\n';
            } else if (shoulderAngle < 90) {
                tips += 'è‚©è†€ä½ç½®è‰¯å¥½ï¼Œç¹¼çºŒä¿æŒï¼\n';
            } else {
                tips += 'è«‹æ›´å¤šåœ°æ”¶ç·Šè‚©èƒ›éª¨ã€‚\n';
            }
            
            return tips;
        }

        // å•éˆ´åˆ’èˆ¹æç¤º
        function getDumbbellRowTips(angleData) {
            if (!angleData) return 'æ­£åœ¨åˆ†ææ‚¨çš„å•éˆ´åˆ’èˆ¹å‹•ä½œ...';
            
            let tips = '';
            const elbowAngle = angleData['è‚˜é—œç¯€è§’åº¦'] || 0;
            const shoulderAngle = angleData['è‚©é—œç¯€è§’åº¦'] || 0;
            const hipAngle = angleData['é«–é—œç¯€è§’åº¦'] || 0;
            
            if (elbowAngle < 60) {
                tips += 'è‚˜éƒ¨å½æ›²è‰¯å¥½ï¼Œå•éˆ´æ‹‰è‡³è…¹éƒ¨ä½ç½®ï¼\n';
            } else if (elbowAngle < 90) {
                tips += 'ç¹¼çºŒå‘ä¸Šæ‹‰å•éˆ´ï¼Œä½¿è‚˜éƒ¨æ›´åŠ å½æ›²ã€‚\n';
            } else {
                tips += 'è‚˜éƒ¨å½æ›²ä¸è¶³ï¼Œè«‹å°‡å•éˆ´æ‹‰å¾—æ›´é«˜ã€‚\n';
            }
            
            if (hipAngle < 100) {
                tips += 'é«–éƒ¨å½æ›²è‰¯å¥½ï¼Œä¸ŠåŠèº«ä¿æŒå¹³è¡Œæ–¼åœ°é¢ï¼\n';
            } else {
                tips += 'è«‹æ›´å¤šåœ°å‰å‚¾ä¸ŠåŠèº«ï¼Œä¿æŒèƒŒéƒ¨å¹³ç›´ã€‚\n';
            }
            
            if (shoulderAngle > 30) {
                tips += 'è‚©è†€éåº¦æŠ¬èµ·ï¼Œè«‹æ”¾é¬†è‚©è†€ã€‚';
            } else {
                tips += 'è‚©è†€ä½ç½®è‰¯å¥½ï¼Œä¿æŒç©©å®šï¼';
            }
            
            return tips;
        }

        // æ›´æ–°æ€ªç‰©ä¿¡æ¯å‡½æ•°
        function updateMonsterInfo(data) {
            if (!monsterContainer) return;
            
            monsterContainer.innerHTML = `
                <h3 style="color:#8D6E63;margin:0 0 10px 0;font-size:18px;">ğŸ² æ€ªç‰©ç‹€æ…‹</h3>
                <div style="margin-bottom:8px;"><strong>åç¨±:</strong> ${data.name || 'æœªçŸ¥'}</div>
                <div style="margin-bottom:8px;"><strong>å¥åº·å€¼:</strong> 
                    <span style="color:${data.health < 30 ? '#F44336' : '#4CAF50'}">${data.health || 0}/100</span>
                </div>
                <div style="margin-bottom:8px;"><strong>ç¶“é©—å€¼:</strong> ${data.exp || 0}</div>
                <div style="margin-bottom:8px;"><strong>ç­‰ç´š:</strong> ${data.level || 1}</div>
                <div><strong>ç‹€æ…‹:</strong> ${data.status || 'æ­£å¸¸'}</div>
            `;
        }
    });
</script>



<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9199a4739c50827c',t:'MTc0MDg0MjQ2OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>